<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Новости — Конструктивистский агрегатор</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/static/css/main.css" />
</head>
<body>
    <main>
        <div class="surface">
            <header class="hero">
                <h1><span>Новости в плакатах</span></h1>
                <p class="tagline">Свежая картина мира из внешних источников, переведённая и превращённая в конструктивистские пиктограммы. Выберите тему, включите перевод и смотрите на события через форму и цвет.</p>
            </header>

            {% if forced_refresh %}
            <div class="flash">Лента обновлена. Последнее обновление: {{ updated_at }}</div>
            {% endif %}

            <form class="controls" method="get">
                <input type="hidden" name="translate" value="off" />
                <input type="hidden" name="view_all" value="off" />
                <input type="hidden" name="refreshed" value="" />
                <div class="search-field">
                    <input type="text" name="q" value="{{ query }}" placeholder="Поиск по заголовкам, описаниям и источникам" />
                </div>
                <div class="toggles">
                    <label class="toggle">
                        <input type="checkbox" name="translate" value="on" {% if translate %}checked{% endif %} />
                        <span class="toggle__indicator"></span>
                        <span class="toggle__label">Перевод на русский</span>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" name="view_all" value="on" {% if view_all %}checked{% endif %} />
                        <span class="toggle__indicator"></span>
                        <span class="toggle__label">Показать список всех новостей</span>
                    </label>
                </div>
                <div class="control-actions">
                    <button type="submit">Искать</button>
                    <button type="submit" name="action" value="refresh" class="refresh-button">Обновить ленту</button>
                </div>
            </form>

            <div class="summary-bar">
                <span class="stat-chip"><strong>{{ matches }}</strong> материалов из {{ total }}</span>
                {% if query %}
                <span class="stat-chip">Запрос: «{{ query }}»</span>
                <a href="/">Сбросить поиск</a>
                {% endif %}
                <span class="timestamp">Последнее обновление: {{ updated_at }}</span>
            </div>

            {% if items %}
            <section class="cards">
                {% for item in items %}
                <article class="card" style="--accent: {{ item.accent }};">
                    <div class="card-header">
                        <span class="source-pill">{{ item.source }}</span>
                        <span class="published">{{ item.time }}</span>
                    </div>
                    <div class="pictogram-wrapper">
                        <img src="{{ item.pictogram_url }}" alt="Плакат новости" loading="lazy" />
                    </div>
                    <div class="card-body">
                        <h2>{{ item.title_display }}</h2>
                        <div class="original">
                            <span class="original-label">Оригинал</span>
                            <div>{{ item.orig_title }}</div>
                        </div>
                        <p class="description">{{ item.summary_display }}</p>
                        {% if item.orig_desc %}
                        <p class="original">{{ item.orig_desc }}</p>
                        {% endif %}
                        <div class="card-footer">
                            <a href="{{ item.link }}" target="_blank" rel="noopener">Читать источник</a>
                            {% if item.image %}
                            <a href="{{ item.image }}" target="_blank" rel="noopener">Первичный визуал</a>
                            {% endif %}
                            <span class="timestamp">{{ item.relative_time }}</span>
                        </div>
                    </div>
                </article>
                {% endfor %}
            </section>
            {% else %}
            <div class="no-results">Не найдено материалов по текущему запросу. Попробуйте изменить ключевые слова или отключите фильтр.</div>
            {% endif %}

            {% if view_all and all_news %}
            <section class="all-news">
                <h2>Все загруженные материалы</h2>
                <ul>
                    {% for entry in all_news %}
                    <li>
                        <span class="source">{{ entry.source }}</span>
                        <a href="{{ entry.link }}" target="_blank" rel="noopener">{{ entry.title }}</a>
                        <span class="time">{{ entry.time }} · {{ entry.relative_time }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </section>
            {% endif %}

            <footer class="note">
                Источники: BBC, Al Jazeera, Jerusalem Post, Haaretz, Times of Israel, Kyiv Independent, Guardian, Associated Press, Deutsche Welle, Sky News. Данные обновляются на лету; кэширование используется для ускорения и экономии запросов.
            </footer>
        </div>
    </main>
</body>
</html>
